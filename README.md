# Database Security Platform (REST API Version)

Проект "Database Security Platform" представляет собой систему для мониторинга активности баз данных, централизованного сбора событий безопасности и удаленного управления командами на клиентских устройствах. Эта версия использует REST API для взаимодействия между компонентами.

## Оглавление

1.  [Архитектура](#архитектура)
2.  [Технологический стек](#технологический-стек)
3.  [Структура проекта](#структура-проекта)
4.  [Настройка и запуск](#настройка-и-запуск)
    *   [Предварительные требования](#предварительные-требования)
    *   [Настройка переменных окружения](#настройка-переменных-окружения)
    *   [Запуск с Docker Compose](#запуск-с-docker-compose)
    *   [Первоначальная настройка клиента](#первоначальная-настройка-клиента)
5.  [Бэкенд (FastAPI)](#бэкенд-fastapi)
    *   [Основные эндпоинты API](#основные-эндпоинты-api)
    *   [Аутентификация клиента](#аутентификация-клиента)
6.  [Фронтенд администратора (Streamlit)](#фронтенд-администратора-streamlit)
    *   [Доступ](#доступ)
    *   [Основные разделы](#основные-разделы)
7.  [Клиентский агент (Пример)](#клиентский-агент-пример)
    *   [Функциональность](#функциональность)
    *   [Настройка и запуск](#настройка-и-запуск-агента)
8.  [Возможные улучшения (для REST API версии)](#возможные-улучшения-для-rest-api-версии)

## Архитектура

Система состоит из следующих основных компонентов:

1.  **Бэкенд (Backend)**:
    *   Реализован на FastAPI (Python).
    *   Предоставляет REST API для взаимодействия с другими компонентами.
    *   Отвечает за бизнес-логику, обработку данных, взаимодействие с базой данных.
    *   Хранит информацию о клиентах, событиях безопасности и командах.
2.  **База данных (Database)**:
    *   PostgreSQL.
    *   Используется для персистентного хранения всех данных платформы.
3.  **Фронтенд администратора (Frontend Admin)**:
    *   Реализован на Streamlit (Python).
    *   Предоставляет веб-интерфейс для администраторов для управления клиентами, просмотра логов событий и отправки команд.
    *   Взаимодействует с бэкендом через его REST API.
4.  **Клиентский агент (Client Agent Example)**:
    *   Пример приложения на Python, которое эмулирует работу агента на клиентском устройстве.
    *   Отправляет события безопасности на бэкенд.
    *   Периодически запрашивает команды с бэкенда и имитирует их выполнение.
    *   Отправляет "heartbeat" сигналы для подтверждения своей активности.
    *   Взаимодействует с бэкендом через его REST API, используя API-ключ для аутентификации.

Все компоненты (кроме локально запускаемого агента) предназначены для запуска в Docker-контейнерах и оркестрируются с помощью Docker Compose.

## Технологический стек

*   **Бэкенд**:
    *   Python 3.11
    *   FastAPI
    *   SQLModel (для работы с БД и валидации данных)
    *   Psycopg2 (драйвер PostgreSQL)
    *   Uvicorn (ASGI сервер)
    *   Passlib (для хеширования API-ключей)
    *   Pydantic-settings (для управления конфигурацией)
*   **Фронтенд администратора**:
    *   Python 3.11
    *   Streamlit
    *   Requests (для HTTP-запросов к бэкенду)
    *   Pandas (для отображения табличных данных)
*   **Клиентский агент**:
    *   Python 3.11
    *   Requests
    *   Schedule (для периодических задач)
    *   Python-dotenv
*   **База данных**:
    *   PostgreSQL 15
*   **Оркестрация и контейнеризация**:
    *   Docker
    *   Docker Compose

## Структура проекта
```
.
├── backend
│   ├── app
│   │   ├── api
│   │   │   ├── deps.py
│   │   │   ├── __init__.py
│   │   │   ├── __pycache__
│   │   │   │   ├── deps.cpython-311.pyc
│   │   │   │   └── __init__.cpython-311.pyc
│   │   │   └── v1
│   │   │       ├── api_v1.py
│   │   │       ├── endpoints
│   │   │       │   ├── clients.py
│   │   │       │   ├── commands.py
│   │   │       │   ├── events.py
│   │   │       │   └── __pycache__
│   │   │       │       ├── clients.cpython-311.pyc
│   │   │       │       ├── commands.cpython-311.pyc
│   │   │       │       └── events.cpython-311.pyc
│   │   │       ├── __init__.py
│   │   │       └── __pycache__
│   │   │           ├── api_v1.cpython-311.pyc
│   │   │           └── __init__.cpython-311.pyc
│   │   ├── core
│   │   │   ├── config.py
│   │   │   ├── __pycache__
│   │   │   │   ├── config.cpython-311.pyc
│   │   │   │   └── security.cpython-311.pyc
│   │   │   └── security.py
│   │   ├── crud
│   │   │   ├── crud_client.py
│   │   │   ├── crud_command.py
│   │   │   ├── crud_event.py
│   │   │   ├── __init__.py
│   │   │   └── __pycache__
│   │   │       ├── crud_client.cpython-311.pyc
│   │   │       ├── crud_command.cpython-311.pyc
│   │   │       ├── crud_event.cpython-311.pyc
│   │   │       └── __init__.cpython-311.pyc
│   │   ├── db
│   │   │   ├── base_class.py
│   │   │   ├── database.py
│   │   │   ├── init_db.py
│   │   │   ├── __init__.py
│   │   │   └── __pycache__
│   │   │       ├── database.cpython-311.pyc
│   │   │       └── __init__.cpython-311.pyc
│   │   ├── __init__.py
│   │   ├── main.py
│   │   ├── models
│   │   │   ├── client.py
│   │   │   ├── command.py
│   │   │   ├── event.py
│   │   │   ├── __init__.py
│   │   │   └── __pycache__
│   │   │       ├── client.cpython-311.pyc
│   │   │       ├── command.cpython-311.pyc
│   │   │       ├── event.cpython-311.pyc
│   │   │       └── __init__.cpython-311.pyc
│   │   ├── __pycache__
│   │   │   ├── __init__.cpython-311.pyc
│   │   │   └── main.cpython-311.pyc
│   │   └── schemas
│   │       ├── client.py
│   │       ├── command.py
│   │       ├── event.py
│   │       ├── __init__.py
│   │       └── token.py
│   ├── Dockerfile
│   ├── requirements.txt
│   └── tests
├── client_agent_example
│   ├── client.py
│   ├── Dockerfile
│   └── requirements.txt
├── docker-compose.yml
├── frontend_admin
│   ├── app.py
│   ├── Dockerfile
│   ├── pages
│   │   ├── 1_Clients_Dashboard.py
│   │   ├── 2_Events_Log.py
│   │   └── 3_Command_Control.py
│   ├── requirements.txt
│   └── utils
│       ├── api_client.py
│       ├── __init__.py
│       └── __pycache__
│           ├── api_client.cpython-311.pyc
│           └── __init__.cpython-311.pyc
└── README.md
```

## Настройка и запуск

### Предварительные требования

*   **Docker**: Установленный и запущенный Docker Engine.
*   **Docker Compose**: Установленный Docker Compose.

### Настройка переменных окружения

1.  **Создайте корневой `.env` файл**: Скопируйте `example.env` (если есть) или создайте новый файл `.env` в корневой директории проекта.
2.  **Заполните `.env` файл**:
    ```env
    # PostgreSQL Settings
    POSTGRES_SERVER=db
    POSTGRES_USER=youruser
    POSTGRES_PASSWORD=yourpassword
    POSTGRES_DB=appdb
    # DATABASE_URL будет автоматически сгенерирован в backend/app/core/config.py
    # из переменных выше, но если вы хотите переопределить:
    # DATABASE_URL=postgresql://youruser:yourpassword@db/appdb

    # Backend API Settings
    API_V1_STR=/api/v1
    # ВАЖНО: Замените этот ключ на свой собственный, длинный и случайный!
    SECRET_KEY=your_super_secret_key_which_should_be_long_and_random
    ACCESS_TOKEN_EXPIRE_MINUTES=30 # Используется, если будет JWT аутентификация для админов

    # Streamlit App Settings (frontend_admin)
    STREAMLIT_SERVER_PORT=8501
    # URL для доступа к бэкенду из контейнера frontend_admin
    BACKEND_API_URL=http://backend:8000

    # Client Agent Settings (эти переменные будут использоваться, если агент
    # также запускается через docker-compose и читает из этого .env,
    # но в данной конфигурации агент использует свой собственный .env файл)
    # CLIENT_AGENT_BACKEND_URL=http://backend:8000
    # CLIENT_AGENT_API_KEY= # Этот ключ получается после регистрации клиента
    ```
    **Примечание**: `DATABASE_URL` в `backend/app/core/config.py` собирается из отдельных переменных `POSTGRES_...`.

### Запуск с Docker Compose

1.  Откройте терминал в корневой директории проекта.
2.  Выполните команду для сборки образов и запуска контейнеров:
    ```bash
    docker-compose up --build
    ```
    Для запуска в фоновом режиме используйте:
    ```bash
    docker-compose up --build -d
    ```
3.  После успешного запуска будут доступны:
    *   **Бэкенд API**: `http://localhost:8000` (OpenAPI документация: `http://localhost:8000/api/v1/openapi.json`, Swagger UI: `http://localhost:8000/docs`)
    *   **Фронтенд администратора**: `http://localhost:8501` (или порт, указанный в `STREAMLIT_SERVER_PORT`)
    *   **PostgreSQL**: Порт `5432` будет проброшен на хост, если вы хотите подключиться к БД напрямую.

### Первоначальная настройка клиента

1.  **Доступ к админ-панели**: Откройте в браузере `http://localhost:8501`.
2.  **Регистрация клиента**:
    *   Перейдите в раздел "Clients Dashboard".
    *   В секции "Регистрация нового клиента" введите имя клиента (например, `test-agent-01`) и, опционально, информацию об ОС и IP.
    *   Нажмите "Зарегистрировать клиента".
    *   **ВАЖНО**: Скопируйте и сохраните отобразившийся **API ключ**. Он показывается только один раз. Этот ключ потребуется для настройки клиентского агента.

## Бэкенд (FastAPI)

Бэкенд предоставляет REST API для всех операций.

### Основные эндпоинты API

Все эндпоинты имеют префикс `/api/v1`.

**Клиенты (Администрирование - без специальной админ-аутентификации в этой версии):**

*   `POST /admin/clients`: Регистрация нового клиента.
    *   Тело запроса: `ClientCreate` (имя клиента, опц. IP, ОС).
    *   Ответ: `ClientReadWithApiKey` (включая нехешированный API ключ).
*   `GET /admin/clients`: Получение списка клиентов.
*   `GET /admin/clients/{client_id}`: Получение информации о конкретном клиенте.

**Клиенты (Действия от имени аутентифицированного клиента):**

*   `POST /clients/heartbeat`: Отправка сигнала "heartbeat" от клиента.
    *   Требует заголовок `X-API-Key`.
    *   Ответ: `ClientRead`.

**События безопасности:**

*   `POST /events`: Отправка одного или нескольких событий безопасности от клиента.
    *   Требует заголовок `X-API-Key`.
    *   Тело запроса: список `SecurityEventCreate`.
    *   Ответ: список `SecurityEventRead`.
*   `GET /admin/events`: Получение лога событий безопасности (для админки).
    *   Поддерживает фильтрацию и пагинацию.

**Команды:**

*   `POST /admin/commands`: Создание новой команды для клиента администратором.
    *   Тело запроса: `CommandCreate` (включая `client_id` целевого клиента).
    *   Ответ: `CommandRead`.
*   `GET /admin/commands`: Получение списка всех команд в системе (для админки).
*   `GET /admin/commands/{command_id}`: Получение информации о конкретной команде (для админки).
*   `GET /commands`: Запрос клиентом новых команд, ожидающих выполнения (`pending_dispatch`).
    *   Требует заголовок `X-API-Key`.
    *   Сервер меняет статус полученных команд на `dispatched`.
    *   Ответ: список `CommandRead`.
*   `PATCH /commands/{command_id}`: Обновление статуса выполнения команды клиентом.
    *   Требует заголовок `X-API-Key`.
    *   Тело запроса: `CommandUpdateByClient` (новый статус, результат выполнения).
    *   Ответ: `CommandRead`.

### Аутентификация клиента

Клиентские агенты аутентифицируются на бэкенде с помощью API-ключа, передаваемого в HTTP-заголовке `X-API-Key`.
Зависимость `get_current_client` в `backend/app/api/deps.py` отвечает за проверку этого ключа.

**Важно по аутентификации в `deps.py`:** Текущая реализация `get_current_client` перебирает всех клиентов из БД для проверки API-ключа. Это неэффективно для большого количества клиентов и должно быть оптимизировано в производственной среде.

## Фронтенд администратора (Streamlit)

Веб-интерфейс для управления платформой.

### Доступ

*   URL: `http://localhost:STREAMLIT_SERVER_PORT` (по умолчанию `http://localhost:8501`).
*   **Аутентификация**: В данной версии проекта явная аутентификация для доступа к админ-панели Streamlit **не реализована**. Доступ контролируется только сетевой доступностью.

### Основные разделы

Навигация осуществляется через боковое меню:

1.  **Clients Dashboard (`1_Clients_Dashboard.py`)**:
    *   Регистрация новых клиентов и генерация для них API-ключей.
    *   Просмотр списка зарегистрированных клиентов, их статусов и основной информации.
    *   Просмотр деталей конкретного клиента.
2.  **Events Log (`2_Events_Log.py`)**:
    *   Просмотр лога событий безопасности, полученных от клиентов.
    *   Фильтрация событий по клиенту, типу события, уровню серьезности, дате.
    *   Пагинация для удобного просмотра больших объемов данных.
3.  **Command Control (`3_Command_Control.py`)**:
    *   Создание и отправка команд на клиентские устройства.
    *   Просмотр списка всех отправленных команд и их текущих статусов.
    *   Фильтрация команд по клиенту и статусу.
    *   Просмотр деталей конкретной команды.

## Клиентский агент (Пример)

Находится в директории `client_agent_example`.

### Функциональность

*   **Аутентификация**: Использует API-ключ для взаимодействия с бэкендом.
*   **Heartbeat**: Периодически отправляет сигнал "heartbeat" на сервер для подтверждения активности.
*   **Отправка событий**: Генерирует и отправляет случайные события безопасности на сервер.
*   **Получение команд**: Периодически запрашивает новые команды с сервера.
*   **Обработка команд**: Имитирует выполнение полученных команд (например, `log_message`, `block_ip`) и обновляет их статус на сервере.

### Настройка и запуск (агента)

**1. Создание `.env` файла для агента:**
   В директории `client_agent_example` создайте файл `.env` (если его нет) со следующим содержимым:
   ```env
   # client_agent_example/.env
   CLIENT_AGENT_BACKEND_URL=http://localhost:8000 # Если бэкенд запущен локально или проброшен на localhost
   # Для запуска агента в Docker Compose из той же сети, используйте:
   # CLIENT_AGENT_BACKEND_URL=http://backend:8000
   
   CLIENT_AGENT_API_KEY=ВАШ_API_КЛЮЧ_ПОЛУЧЕННЫЙ_ИЗ_АДМИНКИ
   
   # Опциональные интервалы в секундах
   CLIENT_HEARTBEAT_INTERVAL_SECONDS=60
   EVENT_SEND_INTERVAL_SECONDS=120
   COMMAND_FETCH_INTERVAL_SECONDS=30
Use code with caution.
Замените ВАШ_API_КЛЮЧ_ПОЛУЧЕННЫЙ_ИЗ_АДМИНКИ на ключ, который вы получили при регистрации клиента.

2. Установка зависимостей (если запускать локально без Docker):

pip install -r client_agent_example/requirements.txt
Use code with caution.
Bash
3. Запуск (локально без Docker):

python client_agent_example/client.py
Use code with caution.
Bash
Запуск агента через Docker Compose (рекомендуется для эмуляции сетевого взаимодействия):
Сервис client_agent уже описан в docker-compose.yml. Он будет использовать свой .env файл (client_agent_example/.env) при запуске через docker-compose up. Убедитесь, что CLIENT_AGENT_BACKEND_URL в client_agent_example/.env установлен в http://backend:8000, чтобы агент мог найти сервис бэкенда внутри Docker-сети.

